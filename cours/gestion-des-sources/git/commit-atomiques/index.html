<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>commit atomiques</title>

    <link href="/cours_informatique/assets/node_modules/prismjs/themes/prism-solarizedlight.css" rel="stylesheet">
    
    <link href="/cours_informatique/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">
    <script src="/cours_informatique/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.js"></script>

    <link href="/cours_informatique/assets/stylesheets/main.css" rel="stylesheet">

  </head>
  <body>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            [
              '$', '$'
            ],
            [
              '\\(', '\\)'
            ]
          ]
        },
        svg: {
          fontCache: 'global'
        }
      };

      function goTop() {
        window.scrollTo({top: 0});
      }
      function goBottom() {
        window.scrollTo({top: document.body.scrollHeight});
      }
    </script>
    <script type="text/javascript" id="MathJax-script" src="/cours_informatique/assets/node_modules/mathjax/es5/tex-svg-full.js"></script>

    <header class="border-b-2 border-gray-200 mb-4">
      <div class="max-w-[1200px] mx-auto px-4 relative">
        <div class="min-h-[50px] flex justify-between items-center">
          <a class="mx-2" href="/cours_informatique/">Home</a>
        </div>

        <div class="min-h-[50px] flex justify-center items-center absolute right-0 top-0">
          <a class="mx-2" href="/cours_informatique/about">About</a>
          <button onclick="goTop()" id="myBtn" title="Go to top">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 11.25l-3-3m0 0l-3 3m3-3v7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </button>

          <button onclick="goBottom()" id="myBtn" title="Go to top">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </button>
        </div>

      </div>
    </header>

    <main class="max-w-[1200px] mx-auto px-4">
      
<article>

  <h1 class="mb-1">commit atomiques</h1>
  <div class="mb-4">
    

    
      <div class=" px-4 flex items-center">
        
          <div class="font-bold">Auteur : </div>
        
        <ul class="flex not-prose list-none my-0 last:after:content-['•'] last:after:px-1 mx-0 px-1">
          
            <li class="before:content-['•'] before:px-1">Fanis Michalakis</li>
          
        </ul>
      </div>
    
  </div>

  

    
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-purple-500 bg-purple-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
</svg>
<div class="pl-8 mr-8">

<a class="interne" href="/cours_informatique/cours/">Cours</a><span class="px-1">/</span><a class="interne" href="/cours_informatique/cours/gestion-des-sources/">Gestion des sources</a><span class="px-1">/</span><a class="interne" href="/cours_informatique/cours/gestion-des-sources/git/">Git dans les détails</a><span class="px-1">/</span><a class="interne" href="/cours_informatique/cours/gestion-des-sources/git/commit-atomiques/">commit atomiques</a>

</div></div>



    
  

  <!-- début résumé -->
<p>Ce tuto vise à apporter <strong>une</strong> réponse (parmi tant d'autres) à la séculaire question : &quot;Mais du coup, quand est-ce que je commit ?&quot;.</p>
<!-- fin résumé -->
<h2>Présentation</h2>
<p>Lorsqu'on débute avec Git, ou même lorsqu'on est un utilisateur plus confirmé, cette question relative à la fréquence de <em>commit</em> revient régulièrement sur la table, notamment lors d'un travail collectif. Disons-le d'emblée, il n'y a pas vraiment de <em>bonne réponse</em> à cette question, si ce n'est peut-être celle-ci : utilisez git de la manière la plus efficace et intuitive pour vous et votre workflow personnel, tant que cela ne nuit pas au reste du groupe. Facile, non ?</p>
<p>Ce petit tuto prend toutefois le partie de présenter un mode de fonctionnement spécifique, celui des <strong>commits atomiques</strong>. C'est une méthode assez répandue parmi les développeurs, en particulier dans le monde de l'<em>open source</em>. Mais ça ne signifie pas forcément qu'elle vous conviendra. Prêt(e) ? C'est parti !</p>
<h2>L'idée générale</h2>
<p>Globalement, l'idée est la suivante : on va découper les modifications apportées au code en tout petits morceaux élémentaires (des <em>atomes</em>, du grec ἄτομος [átomos], « insécable » ) que l'on <em>commit</em> au fur et à mesure. Une nouvelle fonction écrite ? Un commit. Une correction faite en passant ? Un commit. Etc, etc. Bien sûr, le niveau de granularité de ce découpage arbitraire dépend des goûts et des couleurs de chacun. Là encore, il faut se laisser guider par son <em>workflow</em> personnel, et ne pas oublier que git est un outil au service du développeur, et pas l'inverse.</p>
<p>Ensuite, on va souvent vouloir retravailler un peu son historique git pour le rendre plus lisible. En effet, avec tous ces petits <em>commits</em> atomiques, un relecteur peut vite être perdu dans la masse.</p>
<p>Mais à quoi bon faire ces petits <em>commits</em> si c'est pour ensuite retravailler l'historique ? Imaginons que je travaille sur l'ajout d'une nouvelle fonctionnalité. J'écris de nouvelles lignes de code pour y parvenir et, au passage, je tombe sur une ligne déjà écrite qui aura bien besoin d'une petite correction. Deux options : soit je me la note sur une todo list et j'y reviendrai plus tard, soit je m'en occupe tout de suite. Certains sont plutôt partisan de la première option, car elle permet de rester focus sur la tache en cours. Son principal défaut, cependant, est que la correction prendra ensuite plus de temps, parce qu'il faudra revenir plus tard à la todo-list, rouvrir le fichier, retrouver la ligne, comprendre ce qui ne va pas et qui était si évident quelques heures plus tôt mais ne l'est plus forcément.</p>
<p>Si la modification est rapide à faire (une quinzaine de secondes), nous dit la seconde école, autant la faire tout de suite. Chip, chop, je change le type de cette variable, et me voilà reparti sur ma fonctionnalité principale. Sauf que, si je n'y prends pas garde, ma petite correction va être ajoutée au milieu de tout le reste une fois que j'aurai poussé le code de la nouvelle fonctionnalité, ce qui peut perturber la relecture, parfois grandement. On pourrait l'indiquer dans le commentaire du <em>commit</em> ou la <em>pull request</em> mais, là encore, on risque d’accroître la confusion plus qu'autre chose.</p>
<h2>Le commit atomique à la rescousse</h2>
<p>C'est là que le <em>commit</em> atomique intervient. Chip, chop, je change le type d'une variable, et je commit directement cette toute petite modification. Je peux ensuite revenir à ma tache principale l'esprit tranquille. En tout, cette petite digression n'aura duré que quelques secondes, le temps de changer une ligne et de la <em>commit</em>.</p>
<p>Mais à force, je risque à la fin d'avoir un gloubi-boulga dantesque de commits consécutifs, certains relatifs à la nouvelle fonctionnalité en cours d'ajout, et d'autres de simple petites modifications annexes réalisées à la volée. Pas tellement plus lisible que si on faisait un seul gros <em>commit</em>.</p>
<p>C'est pour ça qu'une fois qu'on a planté tous nos petits <em>commit</em> au fur et à mesure, il est bon, une fois qu'on a tout fini, de revenir dessus pour les jardiner. Git permet en effet de déplacer les commits pour les réordonner, et également de fusionner des <em>commits</em> entre eux pour qu'ils n'en forment plus qu'un seul. Je peux donc, par exemple, réunir en un seul <em>commit</em> toutes mes petites modifications éparses, et un autre les réels ajouts signifiants et utiles à la nouvelle fonctionnalité en cours de développement. Il suffit ensuite de préciser en une ligne de commentaire, lors de la publication, que la partie d'intérêt se trouve dans tel <em>commit</em>. Vos relecteurs, incluant votre futur moi, vous en seront très reconnaissants !</p>
<h2>Chouette, mais comment on fait ?</h2>
<p>Il y a plusieurs petits <em>tricks</em> à connaître et à articuler ensemble pour parvenir au résultat escompté :</p>
<ol>
<li>Comment <em>commit</em> un petit bout de fichier (une ligne par exemple)</li>
<li>Comment &quot;jardiner&quot; ses <em>commits</em> (les déplacer et les fusionner)</li>
</ol>
<h3>Ajouter un 'tit bout</h3>
<p>Pour n'ajouter qu'un morceau de mon fichier index.html (par exemple), on commencer par :</p>
<pre class="language-shell" tabindex="0" data-language="shell"><code class="language-shell"><span class="token function">git</span> <span class="token function">add</span> <span class="token parameter variable">-p</span> index.html</code></pre>
<p>Cela va ouvrir dans le shell une interface permettant de dire à git, petit bout par petit bout, si l'on souhaite le commit ou pas. Une sorte de <em>chatbot</em> avant l'heure. Git réalise de lui-même un découpage en petits morceaux, et il vous soumet les morceaux pour analyse un par un. A vous de lui dire ce que vous voulez en faire, simplement en répondant :</p>
<ul>
<li><code>y</code> pour ajouter le morceau au <em>stage</em> (l'espace de pré-commit)</li>
<li><code>n</code> pour ne pas l'y ajouter</li>
<li><code>s</code> pour demander à git de redécouper ce morceaux en morceaux plus petit (il n'y arrive pas toujours !)</li>
<li><code>e</code> pour ouvrir l'éditeur (vim par exemple) et enlever manuellement (en les supprimant) les passages qu'on ne souhaite pas <em>commit</em>.</li>
</ul>
<p>On s'en rend compte, c'est un outil très puissant, permettant d'aller vite en répondant petit bout par petit bout, et autorisant une granularité aussi fine que possible grâce au mode manuel <code>e</code>.</p>
<h3>Jardinage</h3>
<p>Une fois que l'on a fini de cracher du code, vient le moment de réorganiser un peu tout ça pour plus de clarté (notamment à la relecture). Pour cela, on va déplacer les <em>commits</em> pour mettre ensemble (côte-à-côte) les <em>commits</em> de fonctionnalité, et ensemble ceux qui concernent des fioritures ou de petites modifications éparses. Si j'ai 10 *commits&quot; à réorganiser, il suffit pour commencer d'utiliser :</p>
<pre class="language-shell" tabindex="0" data-language="shell"><code class="language-shell"><span class="token function">git</span> rebase <span class="token parameter variable">-i</span> HEAD~10</code></pre>
<p>L'option <code>-i</code> signifiant &quot;interactif&quot;, et pour cause : la commande nous a ouvert vim, où les 10 derniers commits s'offrent à nous :</p>
<pre class="language-shell" tabindex="0" data-language="shell"><code class="language-shell">pick d2eb036 update td gloutons
pick 88af96b <span class="token function">add</span> extended <span class="token function">git</span> rebase tuto
pick 4da9c73 <span class="token function">add</span> how to and first cheatsheet lines
pick 43d2f7e <span class="token function">add</span> <span class="token function">file</span>
pick 7431bbd <span class="token function">add</span> last commands to cheatsheet
pick 40900b9 delete erroneous line
pick 298dead <span class="token function">add</span> merge how-to
pick ca7b5db <span class="token function">add</span> first part
pick 289eb2a <span class="token function">add</span> <span class="token function">link</span> to rebase tuto
pick a2ce5c6 <span class="token builtin class-name">continue</span> tuto</code></pre>
<div class="quote relative drop-shadow  py-2 pr-2 rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-amber-800 bg-amber-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-amber-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
</svg>
<div class="pl-8 mr-8">
<p>On remarque que l'ordre de présentation est ici inversé par rapport à celui de la commande <code>git log</code> : les plus vieux <em>commits</em> sont en haut (c'est donc plus une stalactite qu'un arbre, ou alors un arbre planté à l'envers).</p>
</div></div>

<p>Nous verrons dans quelques instants ce que signifie le &quot;pick&quot;. Détaillons d'abord comment déplacer les lignes. Pour cela, il suffit de déplacer la ligne d'un <em>commit</em> à l'endroit où on veut qu'elle apparaisse. Sur vim, <code>dd</code> pour couper une ligne, et <code>p</code> pour la coller.</p>
<pre class="language-shell" tabindex="0" data-language="shell"><code class="language-shell">pick 88af96b <span class="token function">add</span> extended <span class="token function">git</span> rebase tuto
pick 4da9c73 <span class="token function">add</span> how to and first cheatsheet lines
pick 7431bbd <span class="token function">add</span> last commands to cheatsheet
pick 298dead <span class="token function">add</span> merge how-to
pick 43d2f7e <span class="token function">add</span> <span class="token function">file</span>
pick ca7b5db <span class="token function">add</span> first part
pick a2ce5c6 <span class="token builtin class-name">continue</span> tuto
pick d2eb036 update td gloutons
pick 40900b9 delete erroneous line
pick 289eb2a <span class="token function">add</span> <span class="token function">link</span> to rebase tuto</code></pre>
<p>Une fois qu'on a tout organisé comme il faut, on va pouvoir passer à l'étape de fusion des commits entre eux. Cela fonctionne un peu à la manière de la coalescence des gouttes d'eau : je peux demander à git de fusionner un <em>commit</em> avec celui du dessus. On utilise pour cela <code>pick</code> et <code>squash</code> : <code>pick</code> va conserver un commit, et <code>squash</code> va fusionner un commit avec celui juste au-dessus.</p>
<pre class="language-shell" tabindex="0" data-language="shell"><code class="language-shell">pick 88af96b <span class="token function">add</span> extended <span class="token function">git</span> rebase tuto
squash 4da9c73 <span class="token function">add</span> how to and first cheatsheet lines
squash 7431bbd <span class="token function">add</span> last commands to cheatsheet
squash 298dead <span class="token function">add</span> merge how-to
pick 43d2f7e <span class="token function">add</span> <span class="token function">file</span>
squash ca7b5db <span class="token function">add</span> first part
squash a2ce5c6 <span class="token builtin class-name">continue</span> tuto
pick d2eb036 updta td gloutons
pick 40900b9 delete erronous line
squash 289eb2a <span class="token function">add</span> <span class="token function">link</span> to rebase tuto</code></pre>
<p>On ferme ensuite l'éditeur (en enregistrant bien sûr). Celui-ci va se rouvrir pour que l'on rentre le message de commit du premier groupe de commits (de 88af96b à 298dead, maintenant fusionnés en un seul). On l'écrit, on enregistre et on ferme. L'éditeur se rouvre pour faire de même avec le second groupe, et ainsi de suite. On notera que l'on aurait aussi pu utiliser <code>fixup</code>, qui converse le message de commit du commit dans lequel les autres se fusionnent, à la place de <code>squash</code>.</p>
<p>Et voilà le résultat, 4 commits au lieu de 10 :</p>
<pre class="language-shell" tabindex="0" data-language="shell"><code class="language-shell">88af96b <span class="token function">add</span> how-to tuto
43d2f7e <span class="token function">add</span> atomic commits tuto
d2eb036 update td gloutons
40900b9 refactor old tutos</code></pre>
<h2>Conclusion</h2>
<p>Les commits atomiques sont un excellent moyen de réorganiser l'historique git, en particulier pour le rendre plus clair pour des relecteurs (ce qui est particulièrement utile sur de gros projets, qu'ils soient internes ou <em>open source</em>). Comme on l'a vu, ce n'est absolument pas synonyme de &quot;je pousse plein de petits commits tout le temps&quot;, puisque la pratique du commit atomique s'accompagne d'une réorganisation de ces-derniers (encore une fois, pour plus de clarté). Même si cela peut sembler fastidieux à mettre en pratique au début, cela devient rapidement très efficace et rapide à utiliser, une fois qu'on s'est familiarisé avec les outils, et peut réellement augmenter la lisibilité de vos publications et votre clarté mentale.</p>
<h2>BIbliographie</h2>
<ul>
<li><a href="http://adopteungit.fr/methodologie/2017/04/26/commits-atomiques-la-bonne-approche.html">adopteungit.fr</a></li>
</ul>


</article>
    </main>

    <footer class="min-h-[50px] border-t-2 border-gray-200 mt-4">
      <div class="max-w-[1200px] mx-auto px-4 relative">
        <div class="min-h-[50px] flex justify-center items-center">
          <p>
            Cours d'informatique de François Brucker
          </p>
        </div>
        <div class="min-h-[50px] flex justify-center items-center absolute right-0 top-0">
          <button onclick="goTop()" id="myBtn" title="Go to top">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 11.25l-3-3m0 0l-3 3m3-3v7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </button>

          <button onclick="goBottom()" id="myBtn" title="Go to top">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </button>
        </div>

      </div>
    </footer>

    <script>
      MathJax
        .startup
        .document
        .getMathItemsWithin(document.body);
    </script>

  </body>
</html>