<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Noyau</title>

    <link href="/cours_informatique/assets/node_modules/prismjs/themes/prism-solarizedlight.css" rel="stylesheet">
    
    <link href="/cours_informatique/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">
    <script src="/cours_informatique/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.js"></script>

    <link href="/cours_informatique/assets/stylesheets/main.css" rel="stylesheet">

  </head>
  <body>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            [
              '$', '$'
            ],
            [
              '\\(', '\\)'
            ]
          ]
        },
        svg: {
          fontCache: 'global'
        }
      };

      function goTop() {
        window.scrollTo({top: 0});
      }
      function goBottom() {
        window.scrollTo({top: document.body.scrollHeight});
      }
    </script>
    <script type="text/javascript" id="MathJax-script" src="/cours_informatique/assets/node_modules/mathjax/es5/tex-svg-full.js"></script>

    <header class="border-b-2 border-gray-200 mb-4">
      <div class="max-w-[1200px] mx-auto px-4 relative">
        <div class="min-h-[50px] flex justify-between items-center">
          <a class="mx-2" href="/cours_informatique/">Home</a>
        </div>

        <div class="min-h-[50px] flex justify-center items-center absolute right-0 top-0">
          <a class="mx-2" href="/cours_informatique/about">About</a>
          <button onclick="goTop()" id="myBtn" title="Go to top">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 11.25l-3-3m0 0l-3 3m3-3v7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </button>

          <button onclick="goBottom()" id="myBtn" title="Go to top">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </button>
        </div>

      </div>
    </header>

    <main class="max-w-[1200px] mx-auto px-4">
      
<article>

  <h1>Noyau</h1>
  <div>
    

    
  </div>

  

    
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-purple-500 bg-purple-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
</svg>
<div class="pl-8 mr-8">

<a class="interne" href="/cours_informatique/cours/">Cours</a><span class="px-1">/</span><a class="interne" href="/cours_informatique/cours/système-et-réseau/">Système et réseau</a><span class="px-1">/</span><a class="interne" href="/cours_informatique/cours/système-et-réseau/système-exploitation/">Système d&#39;exploitation</a><span class="px-1">/</span><a class="interne" href="/cours_informatique/cours/système-et-réseau/système-exploitation/noyau/">Noyau</a>

</div></div>



    
  

  <p>Le noyau est partie intégrante de tout process. Il est toujours là et s'active de temps en temps pour gérer le système ou permettre l'accès à une ressource (mémoire ou device).</p>
<h2>Emplacement mémoire</h2>
<p>Le noyau est toujours présent en mémoire. Il est placé aux addresses les plus hautes, qu'on appelle <em>kernel space</em>, par opposition au <em>user space</em> qui contient le process :</p>
<pre><code>kernel space
user space
</code></pre>
<p>Sur un adressage de 64b, on réserve le dernier bit pour le noyau (comme un bit de signe) :</p>
<ul>
<li>toutes les adresses dont le dernier bit vaut 1 seront des adresses du kernel space</li>
<li>toutes les adresses dont le dernier bit vaut 0 seront des adresses du user space</li>
</ul>
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-cyan-500 bg-cyan-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Pour les <a href="https://en.wikipedia.org/wiki/X86-64#Virtual_address_space_details">processeurs x86-64</a>, l'adressage ne se fait que sur les 48 premiers bits donc allant des bits 0 à 47 (les bits 48 à 63 sont forcé à être identiques au bit numéro 47), le kernel space est donc déterminé par la valeur du bit numéro 47, l'espace d'adressage total est donc de $2^{48}$B = 256TiB, les user et kernel space se partageant chacun 126TiB (ça va, ya la place).</p>
</div></div>

<h3>Process et noyau</h3>
<p>On obtient une utilisation de la mémoire suivante, quelque soit le process :</p>
<pre><code>noyau                                  ; accès kernel mode
pile                                   ; accès  user mode
...
bibliothèques partagées                ; accès user mode
...
tas                                    ; accès user mode
données                                ; accès user mode
code                                   ; accès user mode
</code></pre>
<p>La partie noyau est protégée par un <a href="https://fr.wikipedia.org/wiki/Anneau_de_protection">anneau de protection</a> placé par le processeur. Un process ne peut modifier ou accéder à la mémoire du noyau de lui-même, il doit y être invité par un appel système.</p>
<h3>Noyau</h3>
<p>Le <em>kernel space</em> (partie où est stockée le noyau) contient :</p>
<ul>
<li>le code du noyau qui permet :
<ul>
<li>son chargement au boot</li>
<li>d'exécuter des fonctions</li>
</ul>
</li>
<li>une pile pour gérer ses variables et ses appels de fonctions</li>
<li>la gestion des devices par <a href="https://en.wikipedia.org/wiki/Memory-mapped_I/O_and_port-mapped_I/O">IO mapping</a> (adresses logiques pour accéder directement aux devices)</li>
</ul>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-emerald-500 bg-emerald-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"></path>
</svg>
<div class="pl-8 mr-8">
<p>Pour un adressage sur 48bit : <a href="https://www.kernel.org/doc/html/next/arch/x86/x86_64/mm.html#complete-virtual-memory-map-with-4-level-page-tables">mémoire du noyau</a></p>
</div></div>

<h2>Activation du noyau</h2>
<p>Au boot de la machine :</p>
<ol>
<li>le code du noyau se charge en mémoire</li>
<li>des liens avec le processeur son tissés pour associer des actions du noyau à des évènements systèmes.</li>
</ol>
<p>Ce sont ces liens qui permettent l'exécution du noyau une fois le boot terminé. Il consistent en des adresses de fonctions à exécuter selon telle ou telle circonstances</p>
<h3>Slice de temps</h3>
<p>Si le noyau n'a pas été activé depuis un certain laps de temps, il s'active. Ceci est géré par le processeur via le <a href="https://fr.wikipedia.org/wiki/High_Precision_Event_Timer">HPET</a> : Lorsqu'un certain laps de temps est passé, une fonction du noyau est appelée (l'adresse de cette fonction est stockée dans un registre du processeur).</p>
<p>C'est un cas particulier d'interruption.</p>
<h3>Interruptions</h3>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-emerald-500 bg-emerald-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"></path>
</svg>
<div class="pl-8 mr-8">
<p><a href="https://linux-kernel-labs.github.io/refs/heads/master/so2/lec4-interrupts.html">https://linux-kernel-labs.github.io/refs/heads/master/so2/lec4-interrupts.html</a></p>
</div></div>

<p>Les <a href="https://fr.wikipedia.org/wiki/Interruption_(informatique)">interruptions</a> sont des évènements  qui nécessitent une réponse immédiate du noyau. Le processeur possède une table qui associe à chaque numéro d'interruption une adresse contenant la fonction du noyau à utiliser.</p>
<p>Il y a 256 interruptions possibles, et sont dépendantes du processeur et du système d'exploitation. On peut les <a href="https://linux-kernel-labs.github.io/refs/heads/master/lectures/interrupts.html#interrupt-descriptor-table">organiser comme suit sous Linux</a> :</p>
<ul>
<li>de 0 à 31 : exceptions</li>
<li>de 32 à 127 : issus des devices</li>
<li>128 (0x80) : façon alternative d'utiliser des appels systèmes (conservé pour des raisons de compatibilités). Mais préférez l'instruction <a href="https://www.felixcloutier.com/x86/syscall.html">syscall</a>, plus rapide.</li>
<li>129 à 255 : autres interruptions</li>
</ul>
<p>Lorsqu'une interruption est déclarée, processeur appelle la fonction du noyau concernée, une interruption pouvant bien sur être elle même interrompue (sauf par une interruptions déjà en cours d'exécution).</p>
<h4>Matériel</h4>
<p>Les interruptions de 32 à 127 sont générés par le matériel et permettent :</p>
<ul>
<li>soit d'avertir qu'une opération en court est terminée (lire ou écrire un fichier par exemple)
générés par le matériel</li>
<li>soit d'avertir d'un évènement (une touche du clavier à été appuyée)</li>
</ul>
<p>Il n'y a pas de liste proprement dites, puisqu'elles dépendent du matériel.</p>
<h4>Exceptions</h4>
<p>Les exceptions sont des interruptions spéciales, lancées par le processeur. Il y en a 32 et leur <a href="https://wiki.osdev.org/Exceptions">liste est connue</a> : elles vont de la division par 0 (la 0x0), à l’instruction invalide (0x6) à la page fault (0xE).</p>
<h3>Appels systèmes</h3>
<p>Les <a href="https://fr.wikipedia.org/wiki/Appel_syst%C3%A8me">appels systèmes</a> permettent à un process d'appeler le noyau. Ils le font en utilisant une instruction spéciale du processeur (<a href="https://www.felixcloutier.com/x86/syscall.html">syscall</a>) qui appelle une fonction du noyau. Comme pour les interruptions, l'adresse de la fonction à appeler est fixée au boot.</p>
<p>On les utilise pour de multiples raisons, allant de la reservation de mémoire à la demande d'accès à un fichier : à chaque fois qu'un process veut accéder à autre chose que son code ou ses données, il doit le faire fia un appel système.</p>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-emerald-500 bg-emerald-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"></path>
</svg>
<div class="pl-8 mr-8">
<p><a href="https://filippo.io/linux-syscall-table/">Liste des appels systèmes pour Linux</a></p>
</div></div>

<h3>Signaux</h3>
<p>Les signaux permettent à des process de se communiquer des directives. Il y en a <a href="https://en.wikipedia.org/wiki/Signal_(IPC)#POSIX_signals">toute une liste</a> qui permette de gérer l'action d'un process (se tuer, s'arrêter, reprendre son activité, etc).</p>
<p>La gestion des signaux est asynchrone :</p>
<ol>
<li>le process A veut envoyer le signal S au process B</li>
<li>il demande (par un appel système) au noyau de le faire : le process A est donc en cours d'exécution</li>
<li>le noyau marque dans sa gestion du process B que la prochaine fois qu'il s'exécutera, il faudra qu'il traite le signal S (on le fait via un <a href="https://fr.wikipedia.org/wiki/Drapeau_(informatique)">flag</a>)</li>
<li>au bout d'un certain temps, lorsque le process B est activé, il devra exécuter sa gestion du signal S</li>
</ol>
<p>Certains signaux peuvent être ignorées (comme le fait de gérer les touches CTRL+C par exemple), d'autres non (le fait de se tuer violemment (signal <a href="https://fr.wikipedia.org/wiki/SIGKILL">SIGKILL</a>) par exemple ne peut être ignorée alors que la demande polie de se tuer (signal <a href="https://fr.wikipedia.org/wiki/SIGTERM">SIGTERM</a>), oui).</p>
<p>Fun fact, certains appels systèmes combotent avec des signaux. Par exemple l'appel système qui permet de suspendre son exécution tant que le signal de réveil n'est pas activé (très pratique pour un serveur web qui ne va se réveiller que lorsqu'une requête arrive par exemple).</p>
<h2>Gestion de la mémoire</h2>
<blockquote>
<p>TBD : gérer la mémoire pour que tout ne se collisionne pas</p>
<ul>
<li>par process brk() pour augmenter le tas.</li>
</ul>
</blockquote>


</article>
    </main>

    <footer class="min-h-[50px] border-t-2 border-gray-200 mt-4">
      <div class="max-w-[1200px] mx-auto px-4 relative">
        <div class="min-h-[50px] flex justify-center items-center">
          <p>
            Cours d'informatique de François Brucker
          </p>
        </div>
        <div class="min-h-[50px] flex justify-center items-center absolute right-0 top-0">
          <button onclick="goTop()" id="myBtn" title="Go to top">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 11.25l-3-3m0 0l-3 3m3-3v7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </button>

          <button onclick="goBottom()" id="myBtn" title="Go to top">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </button>
        </div>

      </div>
    </footer>

    <script>
      MathJax
        .startup
        .document
        .getMathItemsWithin(document.body);
    </script>

  </body>
</html>